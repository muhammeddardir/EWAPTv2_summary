1. Introduction
2. Flash Security Model
3. Flash Vulnerabilities
4. Pentesting Flash Application
***
1. Introduction
- Adobe Flash is a technology used to create video, animations and other rich content.
- Flash files can be used as standalone applications or be embedded in HTML pages.
- The contents can be developed using several tools: Adobe Flash Professional, Flash Develop, Ajax Animator, Flash Minibuilder, etc.
- To build the logic of the application, Adobe provides a `scripting language called ActionScript,This language is based on ECMA-262 specs Similer JS`
- As opposed to other scripting languages, Flash ActionScript needs to be compiled before execution. The compiled object is in SWF format
- Examples of commercial decompiler:
	- Sothink Flash decompiler
	- Trillix Flash decompiler
- To embed a Flash animation within a web page, you can use an object element with Content-type : application/x-shockwave-Flash --> Flash embed HTML
- The HTML page can embed the Flash animation and specify a param element with the attribute `allowScriptAccess` to describe the policy for communication between the animation and the parent HTML page
- allowScriptAccess
	- Always : The SWF file can always communicate with the HTML page
	- sameDomain : communicate with the HTML if they share the same domain.
	- Never : The SWF file can never communicate with the HTML page
- pass arguments to Flash files. --> three methods
	1. – Direct reference : Flash is not embedded in an HTML page and arguments are provided directly through the URI : ![[Pasted image 20220409070705.png]]
	2. Flash Embedded in HTML page : arguments are passed through the attribute data  of the object element. :![[Pasted image 20220409070822.png]]
	3. FlashArgs attribute : Flash is embedded in the HTML page and arguments are passed through the attribute FlashArgs of the object element. : ![[Pasted image 20220409070952.png]]
*** 
2. Flash Security Model
- Sandbox and stakeholder important concepts in the Flash security paradigm.
- By default, SWF files hosted on the subdomain a.example.com can only access resources (SWF files, images, sounds, text files, etc.) on a.example.com
- When a Flash animation is started by a player, different security controls are performed at different levels.
- **Stakeholders**
	- describe different roles (human or not) involved in the control of security settings.
	- There are four stakeholders: administrator, user, website, and author.
	- Flash security checks are performed, starting from the first stakeholder
	- Each stakeholder can enforce security controls using different means.
	![[Pasted image 20220409074344.png]]
1. Administrative Rule 
	- Who :
		-  configure Flash security settings that will affect all operating system users.
	- How : 
		- `mms.cfg` : This text configuration file is read when Flash player starts,
		-  `The Global Flash Player Trust director` : Administrators can register SWF files as trusted for all operating system users.
2. User Rule
	- Who : 
		- The user role is represented by the operating system user running a Flash animation through the player
	- How : 
		- Settings manager, Settings UI , such as: camera and microphone settings, shared object storage settings, settings related to legacy content, and so on.
		- User Flash Player Trust directory : Users can register SWF files as trusted
3. Website Rule
	- Who :
		- web server component responsible for the delivery of the Flash animation and/or Flash resources to the client.
	- How :
		- Policy File : is a file placed in a specific location on the web server
		- `Note` that this policy file can grant or deny access to resources stored on the current server enforcing the policy. such as : SWF (images, text files, or other SWF files).
	- Example 1 : 
		- A SWF animation (on domain: A.com) tries to access external resources (images and audio files) available on a different domain (B.com).
		- The policy file (crossdomain.xml) on domain B.com will determine if the operation is allowed or not.
		![[Pasted image 20220409072946.png]]
		- Depending on the requested resource, ActionScript can initiate two different types of connection:
			- Document-based server connection for ActionScript objects
				- Loader (to load SWF files or images JPG,PNG,GIF)
				- Sound
				- URLLoader (to load text or binary data)
				- URLStream
			- Socket connection for ActionScript objects
				- Actionscript socket
				- XMLSocket
	- URl Policy File : 
		- This policy file is checked by the Flash player if it is a document-based server connection.
		- This policy file is also known as the Master policy file. : ![[Pasted image 20220409073503.png]]
		- A SWF file can check for policy files in different locations by calling the Security.loadPolicyFile() method.
		- By default, when the Flash file accesses external resources like images, text, sounds, etc., Flash player looks for a file named crossdomain.xml in the root directory of the server.
	- Socket policy file : 
		- This policy file is checked by the Flash player whether or not it is a socket connection. 
		- socket policy file on port 843
		- we refer to this policy file as the Master policy file.
4. Author Rule 
- Who : 
	- The author role is represented by the developer of the Flash animation.
	- This role can affect the interaction between SWF files available on different domains.
- How :
	- The API `Security.allowDomain(<allowedDomain>)` : grants permissions to the following features:
		- Interaction between different SWF files (Flash Cross-Scripting)
		- Display list access
		- Event detection
		- Full access to properties and methods of the Stage object
- Flash Cross Scripting
	- By default, an SWF file cannot access the ActionScript properties and methods of another SWF file available on a different domain.
	- Access is granted only if the accessed SWF allows the domain of the calling SWF.
	- To achieve this goal, the API call Security.allowDomain()
	- Example : 
		- An external SWF animation (domain: A.com) accesses properties and methods of another SWF file available on a different domain (B.com). : ![[Pasted image 20220409074223.png]]
	- Calling JavaScript From Action Script
		- When Flash animations are embedded in HTML pages, ActionScript code (available in the SWF file) can call the parent page’s JavaScript code by using the ExternalInterface class.
		- When Flash animations are embedded in HTML pages, JavaScript code can call Actionscript code included in the embedded Flash file.
	- Method Navigate To URL
		- The method has the following definition - navigateToURL(URLRequest, [target]).
		- This ActionScript method is used to open a URL in the window embedding the Flash file. == js Function `window.open`
		- The parameter URLRequest can contain JavaScript code, such as `javascript: alert('Hello from Actionscript.');`
		- the JavaScript code will be run only if one of the following conditions is true:
			- the SWF file is a locally trusted file
			- SWF file is embedded and the allowScriptAccess rules described above apply
			- the target and the SWF file are part of the same sandbox (they are located in the same subdomain)
			- If input sanitization does not occur, this method can be exploited by malicious users
	- Local shared Object
		- Flash features an internal storage mechanism based on Local Shared Objects :  similar to browser cookies:
			- They can be used to track user activity or to store preferences.
			- They are read only by subdomains that have set them.
			- There are also some significant differences:
				- They are not sent back and forth over HTTP connections.
				- They do not expire
			- They are stored in a dedicated Flash directory, and are shared by all browsers on a system.
			- They can contain complex (and large amounts of) data, so they offer the advanced features of local storage.
			- To create or retrieve a local shared object with ActionScript:
				`var myCookie:SharedObject = SharedObject.getLocal("information");`
				- If the shared object information exists, its properties are retrieved and saved into the object myCookie;	

***
3. Flash Vulnerabilities
- A Flash Parameter injection vulnerability occurs when:
	1. The attacker can insert malicious code into the web application.
	2. passes the input without any significant sanitization
	3. The Flash animation, embedded in the HTML page, does not sanitize input parameters.
	4. The SWF source code allows HTML injections or XSS.
- Example1
	- xss
	-   The following example shows a simple web application vulnerable to this type of attack. `index.php` and `flash.SWF` : ![[Pasted image 20220409081857.png]]
	-  Index.php : This file processes an input argument named site (taking it from the URL of the received request).
	-  Flash.SWF : This file contains ActionScript code which processes the input argument without any sanitization.
	-  How do you exploit this vulnerability?
		-  `site=javascript:alert(document.cookie);`
- Example2
-  Finding Sensitve hardcode information
	- As we said earlier, Flash contents need to be compiled before they can be run.
	- URLs of hidden resources : Resources that should be hidden to regular users
	- Credentials of services
	- An attacker could use a decompiler to decompile the SWF files, obtain the source code and find credentials and other useful information
***
4. Pentesting Flash Application
- Main areas to check are:
	- Client side components (SWF files and container page)
	- Communication protocol between the client side player and the server side components
	- Server side components
	
	- Static analysis of the SWF source code "Client side components"
		- Obtain the source code of the SWF files and search for interesting hard-coded information (URL, credentials info, etc.).
		- Check if input parameters are sanitized.
		- Analysis of the container page (generally the HTML page containing the Flash SWF file):
			- Check the allowScriptAccess parameter.
			- Check if input arguments are sanitized.
		- Analysis of the website hosting the Flash application 
			- Check if the policy file (crossdomain.xml) is configured properly.
		- Search for common vulnerabilities
	- Identify Communication protocol
		- A complex Flash application may make use of web services. So, each request could be sent according to a given protocol:
			- SOAP
			- AMF
			- This step is fundamental because it allows you to define the structure of the requests (including your payloads) that you need to use to check server-side components.
	- Static analysis of Server side components
		- In order to enumerate all backend functions (services)
		- test each of them against common server-side vulnerabilities (SQL injections, RFI, etc.).

***
- **Tools**
	- `SWFinvestigator` : is an interesting tool which allows researchers use to analyze the quality and the security aspects of SWF files. 
		- It contains a fuzzer that searches for XSS vulnerabilities.
		- Features : 
			1. Actionscript 2/3 disassembling
			2. SWF tag viewing
			3. Local Shared Object (LSO) analyzing
			4. Dynamic function calling
***